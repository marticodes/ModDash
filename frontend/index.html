<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ModCase</title>
    <style>
      :root {
        color-scheme: light;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #f4f4f7;
        color: #222;
      }

      .page {
        min-height: 100vh;
        padding: 32px;
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      header h1 {
        margin: 0;
        font-size: 2.25rem;
        letter-spacing: 0.08em;
        font-weight: 600;
        flex: 1;
      }

      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
      }

      .top-actions {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .secondary-button {
        background: #111827;
        background-image: none;
      }

      .layout {
        display: grid;
        grid-template-columns: 360px 1fr;
        gap: 24px;
        flex-grow: 1;
      }

      .card {
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 20px 45px rgba(15, 23, 42, 0.1);
        padding: 28px;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .field label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        font-size: 0.95rem;
      }

      .field textarea {
        width: 100%;
        min-height: 120px;
        border: 1px solid #d8dae5;
        border-radius: 16px;
        padding: 16px;
        font: inherit;
        resize: vertical;
        outline: none;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }

      .field textarea:focus {
        border-color: #6366f1;
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15);
      }

      .hint {
        font-size: 0.85rem;
        color: #6b7280;
        margin-top: 6px;
      }

      button {
        border: none;
        border-radius: 16px;
        padding: 14px 20px;
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }

      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 25px rgba(99, 102, 241, 0.25);
      }

      button:active {
        transform: translateY(0);
        box-shadow: none;
      }

      .results {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .panel {
        background: #fff;
        border-radius: 18px;
        box-shadow: inset 0 0 0 2px #e5e7eb;
        padding: 20px;
        min-height: 220px;
        max-height: calc(100vh - 160px);
        overflow-y: auto;
        font-size: 0.95rem;
        color: #4b5563;
      }

      .panel[data-placeholder]:empty::before {
        content: attr(data-placeholder);
        color: #9ca3af;
      }

      .dataset-table {
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 16px;
        border-radius: 12px;
        background: rgba(99, 102, 241, 0.05);
      }

      .dataset-table h3 {
        margin: 0;
        font-size: 1.05rem;
        color: #3730a3;
      }

      .judge-roster {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 12px;
      }

      .judge-card {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 12px;
        background: #f9fafb;
      }

      .judge-card strong {
        display: block;
        font-size: 1rem;
        margin-bottom: 4px;
      }

      .judge-meta {
        margin: 0 0 8px 0;
        color: #6b7280;
        font-size: 0.9rem;
      }

      .judge-summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 16px;
      }

      .judge-summary-card {
        border: 1px solid #e5e7eb;
        border-radius: 14px;
        padding: 16px;
        background: #fdfdfd;
        box-shadow: 0 6px 20px rgba(15, 23, 42, 0.08);
      }

      .judge-summary-card h4 {
        margin: 0 0 12px 0;
        font-size: 1.05rem;
        color: #1f2937;
      }

      .judge-summary-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .judge-summary-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
        color: #111827;
      }

      .testcase-label {
        font-size: 0.9rem;
        letter-spacing: 0.01em;
        text-transform: uppercase;
        color: #6b7280;
      }

      .testcase-score {
        font-size: 1rem;
        padding: 2px 8px;
        border-radius: 999px;
        background: #eef2ff;
        color: #3730a3;
        font-weight: 700;
      }

      .testcase-rationale {
        margin: 6px 0 0 0;
        color: #374151;
        font-size: 0.92rem;
      }

      .dataset-table .columns {
        margin: 0;
        display: grid;
        gap: 4px;
      }

      .dataset-table .columns dt {
        font-weight: 600;
      }

      .dataset-table .columns dd {
        margin: 0 0 8px 0;
        color: #4b5563;
      }

      .sample-rows {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
      }

      .sample-rows th,
      .sample-rows td {
        border: 1px solid #e5e7eb;
        padding: 6px 8px;
        text-align: left;
      }

      .sample-rows th {
        background: #eef2ff;
      }

      .fallback-note {
        margin: 12px 0 0;
        padding: 12px;
        border-radius: 12px;
        background: rgba(217, 119, 6, 0.12);
        color: #b45309;
        font-weight: 600;
      }

      button:disabled {
        opacity: 0.7;
        cursor: progress;
      }

      .result-toolbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        font-size: 0.9rem;
        color: #4b5563;
      }

      .result-toolbar-left {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .result-toolbar-title {
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .result-toolbar-actions {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .result-toolbar button {
        padding: 8px 14px;
        font-size: 0.85rem;
        border-radius: 999px;
      }

      .chip-toggle {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid #e5e7eb;
        background: #f9fafb;
        font-size: 0.85rem;
        cursor: pointer;
      }

      .chip-toggle input {
        margin: 0;
      }

      .testcase-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .testcase-card {
        border-radius: 14px;
        border: 1px solid #e5e7eb;
        padding: 14px 16px;
        background: #f9fafb;
        display: flex;
        gap: 12px;
      }

      .testcase-checkbox {
        margin-top: 4px;
      }

      .testcase-body {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .testcase-meta {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        font-size: 0.85rem;
        color: #6b7280;
      }

      .testcase-title {
        font-weight: 600;
      }

      .score-pill {
        padding: 2px 10px;
        border-radius: 999px;
        background: #ecfdf3;
        color: #166534;
        font-weight: 600;
        font-size: 0.8rem;
      }

      .testcase-judges {
        margin-top: 4px;
        padding-top: 6px;
        border-top: 1px dashed #e5e7eb;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .testcase-judge-row {
        display: flex;
        justify-content: space-between;
        gap: 8px;
        font-size: 0.85rem;
        color: #374151;
      }

      .testcase-judge-name {
        font-weight: 600;
      }

      .testcase-judge-score {
        font-weight: 600;
        color: #3730a3;
      }

      .testcase-judge-rationale {
        font-size: 0.8rem;
        color: #6b7280;
      }

      .empty-state {
        font-size: 0.95rem;
        color: #9ca3af;
      }

      @media (max-width: 960px) {
        .layout {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <header>
        <h1>ModCase</h1>
        <div class="top-actions">
          <button id="generate-dataset" type="button" class="secondary-button">
            Generate dataset
          </button>
        </div>
      </header>
      <main class="layout">
        <section class="card" aria-labelledby="rule-builder">
          <div class="field">
            <label id="rule-builder" for="rule">Write a rule you want to test...</label>
            <textarea id="rule" name="rule" placeholder="e.g., Block messages containing more than 3 links"></textarea>
          </div>

          <div class="field">
            <label for="example">[Optional] Give an example case</label>
            <textarea
              id="example"
              name="example"
              placeholder="Paste a message or scenario to preview how the rule behaves"
            ></textarea>
            <p class="hint">Use this space to test the rule against a specific message.</p>
          </div>

          <button id="generate" type="button">Generate</button>
        </section>

        <section class="results">
          <div class="result-toolbar">
            <div class="result-toolbar-left">
              <span class="result-toolbar-title">Result</span>
              <label class="chip-toggle">
                <input type="checkbox" id="select-all" />
                <span>Select all</span>
              </label>
              <span id="selection-count">0 selected</span>
            </div>
            <div class="result-toolbar-actions">
              <button type="button" id="delete-selected">Delete</button>
              <button type="button" id="evaluate-selected">Evaluate</button>
              <button type="button" id="generate-more-like">Generate more like these</button>
            </div>
          </div>
          <div
            id="result-panel"
            class="panel"
            data-placeholder="Generated testcases will appear here..."
          ></div>
        </section>
      </main>
    </div>
    <script type="module">
      const ruleField = document.querySelector("#rule");
      const exampleField = document.querySelector("#example");
      const generateButton = document.querySelector("#generate");
      const resultPanel = document.querySelector("#result-panel");
      const generateDatasetButton = document.querySelector("#generate-dataset");
      const selectAllCheckbox = document.querySelector("#select-all");
      const deleteSelectedButton = document.querySelector("#delete-selected");
      const evaluateSelectedButton = document.querySelector("#evaluate-selected");
      const generateMoreLikeButton = document.querySelector("#generate-more-like");
      const selectionCountLabel = document.querySelector("#selection-count");

      const API_BASE = window.__MODDASH_API_BASE__ || "http://127.0.0.1:3001";

      /** In-memory state for current testcases */
      let currentTestcases = [];
      let selectedIds = new Set();
      let lastRule = "";

      function setPanelContent(panel, nodes) {
        panel.innerHTML = "";
        panel.removeAttribute("data-placeholder");
        if (!Array.isArray(nodes)) {
          nodes = [nodes];
        }
        nodes.forEach((node) => panel.append(node));
      }

      function setPanelPlaceholder(panel, text) {
        panel.textContent = "";
        if (text) {
          panel.dataset.placeholder = text;
        } else {
          delete panel.dataset.placeholder;
        }
      }

      function createParagraph(text) {
        const paragraph = document.createElement("p");
        paragraph.textContent = text;
        return paragraph;
      }

      function createPreformatted(text) {
        const pre = document.createElement("pre");
        pre.textContent = text;
        pre.style.whiteSpace = "pre-wrap";
        pre.style.wordBreak = "break-word";
        return pre;
      }

      function createJudgeRoster(judges) {
        const roster = document.createElement("div");
        roster.className = "judge-roster";

        judges.forEach((judge) => {
          const card = document.createElement("article");
          card.className = "judge-card";

          const name = document.createElement("strong");
          name.textContent = judge.name;
          card.append(name);

          const meta = document.createElement("p");
          const experience = judge.experienceYears ? `${judge.experienceYears} yrs exp` : "Perspective";
          meta.className = "judge-meta";
          meta.textContent = `${judge.role} Â· ${experience}`;
          card.append(meta);

          if (judge.personality) {
            const desc = document.createElement("p");
            desc.textContent = judge.personality;
            card.append(desc);
          }
        });

        return roster;
      }

      function parseJudgeSummary(summaryText) {
        if (!summaryText) {
          return [];
        }

        const judgesData = [];
        let currentJudge = null;

        summaryText.split("\n").forEach((rawLine) => {
          const line = rawLine.trim();
          if (!line) {
            return;
          }

          if (line.toLowerCase().startsWith("judge:")) {
            const name = line.slice(line.indexOf(":") + 1).trim();
            if (name) {
              currentJudge = { name, verdicts: [] };
              judgesData.push(currentJudge);
            }
            return;
          }

          if (!currentJudge) {
            return;
          }

          const verdictMatch = line.match(/^-?\s*Testcase\s+(\d+):\s*([\d.]+)%\s*-\s*(.+)$/i);
          if (verdictMatch) {
            currentJudge.verdicts.push({
              testcaseId: Number(verdictMatch[1]),
              percentage: Number(verdictMatch[2]),
              rationale: verdictMatch[3].trim(),
            });
          } else {
            currentJudge.verdicts.push({
              testcaseId: null,
              percentage: null,
              rationale: line,
            });
          }
        });

        return judgesData;
      }

      function createJudgeSummaryCards(summaryText) {
        const parsedJudges = parseJudgeSummary(summaryText);
        if (!parsedJudges.length) {
          return createPreformatted(summaryText);
        }

        const grid = document.createElement("div");
        grid.className = "judge-summary-grid";

        parsedJudges.forEach((judge) => {
          const card = document.createElement("article");
          card.className = "judge-summary-card";

          const name = document.createElement("h4");
          name.textContent = judge.name;
          card.append(name);

          if (Array.isArray(judge.verdicts) && judge.verdicts.length) {
            const list = document.createElement("ul");
            list.className = "judge-summary-list";

            judge.verdicts.forEach((verdict) => {
              const item = document.createElement("li");

              if (typeof verdict.testcaseId === "number") {
                const header = document.createElement("div");
                header.className = "judge-summary-row";

                const label = document.createElement("span");
                label.className = "testcase-label";
                label.textContent = `Testcase ${verdict.testcaseId}`;
                header.append(label);

                if (typeof verdict.percentage === "number" && Number.isFinite(verdict.percentage)) {
                  const score = document.createElement("span");
                  score.className = "testcase-score";
                  score.textContent = `${verdict.percentage}%`;
                  header.append(score);
                }

                item.append(header);
              }

              if (verdict.rationale) {
                const rationale = document.createElement("p");
                rationale.className = "testcase-rationale";
                rationale.textContent = verdict.rationale;
                item.append(rationale);
              }

              list.append(item);
            });

            card.append(list);
          }

          grid.append(card);
        });

        return grid;
      }

      function updateSelectionCount() {
        const count = selectedIds.size;
        selectionCountLabel.textContent = `${count} selected`;
        selectAllCheckbox.checked = count > 0 && count === currentTestcases.length;
      }

      function renderTestcases() {
        if (!currentTestcases.length) {
          setPanelContent(resultPanel, createParagraph("No testcases yet. Click Generate to create some."));
          selectionCountLabel.textContent = "0 selected";
          selectAllCheckbox.checked = false;
          return;
        }

        const list = document.createElement("div");
        list.className = "testcase-list";

        currentTestcases.forEach((tc, index) => {
          const card = document.createElement("article");
          card.className = "testcase-card";

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.className = "testcase-checkbox";
          checkbox.checked = selectedIds.has(index);
          checkbox.addEventListener("change", () => {
            if (checkbox.checked) {
              selectedIds.add(index);
            } else {
              selectedIds.delete(index);
            }
            updateSelectionCount();
          });

          const body = document.createElement("div");
          body.className = "testcase-body";

          const metaRow = document.createElement("div");
          metaRow.className = "testcase-meta";

          const title = document.createElement("span");
          title.className = "testcase-title";
          title.textContent = `Testcase ${index + 1}`;
          metaRow.appendChild(title);

          if (tc.evaluation && typeof tc.evaluation.overallScore === "number") {
            const score = document.createElement("span");
            score.className = "score-pill";
            score.textContent = `Result: ${tc.evaluation.overallScore}%`;
            metaRow.appendChild(score);
          }

          body.appendChild(metaRow);

          if (tc.text) {
            body.appendChild(createPreformatted(tc.text));
          }

          if (tc.evaluation && Array.isArray(tc.evaluation.judges) && tc.evaluation.judges.length) {
            const judgesContainer = document.createElement("div");
            judgesContainer.className = "testcase-judges";

            tc.evaluation.judges.forEach((j) => {
              const row = document.createElement("div");
              row.className = "testcase-judge-row";

              const left = document.createElement("div");
              const name = document.createElement("span");
              name.className = "testcase-judge-name";
              name.textContent = j.name;
              left.appendChild(name);

              if (j.rationale) {
                const rationale = document.createElement("div");
                rationale.className = "testcase-judge-rationale";
                rationale.textContent = j.rationale;
                left.appendChild(rationale);
              }

              const right = document.createElement("span");
              right.className = "testcase-judge-score";
              if (typeof j.percentage === "number" && Number.isFinite(j.percentage)) {
                right.textContent = `${j.percentage}%`;
              }

              row.appendChild(left);
              row.appendChild(right);
              judgesContainer.appendChild(row);
            });

            body.appendChild(judgesContainer);
          }

          card.appendChild(checkbox);
          card.appendChild(body);
          list.appendChild(card);
        });

        setPanelContent(resultPanel, list);
        updateSelectionCount();
      }

      async function handleGenerate() {
        console.log('Generate button clicked');
        const rule = ruleField.value.trim();
        const example = exampleField.value.trim();

        if (!rule) {
          alert("Please enter a rule before generating a dataset.");
          return;
        }

        lastRule = rule;

        console.log('Sending request to:', `${API_BASE}/generate`);
        console.log('Rule:', rule);
        console.log('Example:', example || '(none)');

        generateButton.disabled = true;
        generateButton.textContent = "Generating...";

        setPanelPlaceholder(resultPanel, "Working on it...");
        selectedIds.clear();
        updateSelectionCount();

        try {
          const response = await fetch(`${API_BASE}/generate`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ rule, example: example || null, count: 15 }),
          });

          if (!response.ok) {
            let errorMessage = `Request failed with status ${response.status}`;
            try {
              const errorData = await response.json();
              errorMessage = errorData.error || errorData.details || errorMessage;
              if (errorData.details) {
                errorMessage += `: ${errorData.details}`;
              }
            } catch (e) {
              const text = await response.text();
              if (text) {
                errorMessage = text;
              }
            }
            throw new Error(errorMessage);
          }

          const payload = await response.json();
          console.log('Received payload:', payload);

          const examples = Array.isArray(payload.examples) ? payload.examples : [];
          currentTestcases = examples.map((ex) => ({
            event_type: ex.event_type || ex.eventType || ex.event || null,
            text: ex.text || "",
            trigger: typeof ex.trigger === "boolean" ? ex.trigger : null,
            confidence: typeof ex.confidence === "number" ? ex.confidence : null,
            raw: ex,
            evaluation: null,
          }));
          selectedIds.clear();
          renderTestcases();
        } catch (error) {
          console.error('Error generating content:', error);
          const errorMsg = error.message || "Something went wrong while generating the dataset.";
          setPanelContent(resultPanel, [
            createParagraph("Error: " + errorMsg),
            createParagraph("Check the browser console and server logs for more details.")
          ]);
        } finally {
          generateButton.disabled = false;
          generateButton.textContent = "Generate";
        }
      }

      generateButton.addEventListener("click", () => {
        handleGenerate();
      });

      [ruleField, exampleField].forEach((field) => {
        field.addEventListener("keydown", (event) => {
          if (event.key === "Enter" && (event.metaKey || event.ctrlKey)) {
            event.preventDefault();
            handleGenerate();
          }
        });
      });

      selectAllCheckbox.addEventListener("change", () => {
        if (selectAllCheckbox.checked) {
          selectedIds = new Set(currentTestcases.map((_, idx) => idx));
        } else {
          selectedIds.clear();
        }
        renderTestcases();
      });

      deleteSelectedButton.addEventListener("click", () => {
        if (!selectedIds.size) {
          alert("Select at least one testcase to delete.");
          return;
        }
        currentTestcases = currentTestcases.filter((_, idx) => !selectedIds.has(idx));
        selectedIds.clear();
        renderTestcases();
      });

      async function handleEvaluateSelected() {
        if (!selectedIds.size) {
          alert("Select at least one testcase to evaluate.");
          return;
        }
        if (!lastRule) {
          alert("You need to generate testcases with a rule before evaluating them.");
          return;
        }

        const indices = Array.from(selectedIds.values()).sort((a, b) => a - b);
        const examples = indices.map((idx) => currentTestcases[idx].raw || { text: currentTestcases[idx].text });

        evaluateSelectedButton.disabled = true;
        evaluateSelectedButton.textContent = "Evaluating...";

        try {
          const response = await fetch(`${API_BASE}/evaluate`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ rule: lastRule, examples }),
          });

          if (!response.ok) {
            let msg = `Evaluation failed with status ${response.status}`;
            try {
              const data = await response.json();
              msg = data.error || data.details || msg;
            } catch {
              const text = await response.text();
              if (text) msg = text;
            }
            throw new Error(msg);
          }

          const payload = await response.json();
          const judgeSummaryText = typeof payload.judgeSummary === "string" ? payload.judgeSummary.trim() : "";
          const parsedJudges = parseJudgeSummary(judgeSummaryText);

          const byLocalId = new Map();
          parsedJudges.forEach((judge) => {
            (judge.verdicts || []).forEach((v) => {
              if (typeof v.testcaseId === "number") {
                const localId = v.testcaseId;
                if (!byLocalId.has(localId)) {
                  byLocalId.set(localId, { scores: [], judges: [] });
                }
                const bucket = byLocalId.get(localId);
                if (typeof v.percentage === "number" && Number.isFinite(v.percentage)) {
                  bucket.scores.push(v.percentage);
                }
                bucket.judges.push({
                  name: judge.name,
                  percentage: v.percentage,
                  rationale: v.rationale,
                });
              }
            });
          });

          byLocalId.forEach((bucket, localId) => {
            const globalIndex = indices[localId - 1];
            if (globalIndex == null) return;
            const avg =
              bucket.scores.length > 0
                ? Math.round(bucket.scores.reduce((a, b) => a + b, 0) / bucket.scores.length)
                : null;
            currentTestcases[globalIndex].evaluation = {
              overallScore: avg,
              judges: bucket.judges,
            };
          });

          // Clear selection after evaluation so testcases are no longer highlighted
          selectedIds.clear();

          renderTestcases();
        } catch (error) {
          console.error("Error evaluating testcases:", error);
          alert(error.message || "Something went wrong while evaluating the selected testcases.");
        } finally {
          evaluateSelectedButton.disabled = false;
          evaluateSelectedButton.textContent = "Evaluate";
        }
      }

      evaluateSelectedButton.addEventListener("click", () => {
        handleEvaluateSelected();
      });

      async function handleGenerateMoreLike() {
        if (!selectedIds.size) {
          alert("Select at least one testcase to generate similar ones.");
          return;
        }
        if (!lastRule) {
          alert("You need a rule before generating similar testcases.");
          return;
        }

        // Use the selected testcases' text as an aggregated example to steer generation.
        const selectedTexts = Array.from(selectedIds.values())
          .sort((a, b) => a - b)
          .map((idx) => currentTestcases[idx].text)
          .filter(Boolean);

        if (!selectedTexts.length) {
          alert("Selected testcases have no text to condition on.");
          return;
        }

        const example = selectedTexts.join("\n\n---\n\n");

        try {
          generateMoreLikeButton.disabled = true;
          generateMoreLikeButton.textContent = "Generating...";

          const response = await fetch(`${API_BASE}/generate`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ rule: lastRule, example, count: 5 }),
          });

          if (!response.ok) {
            let errorMessage = `Request failed with status ${response.status}`;
            try {
              const errorData = await response.json();
              errorMessage = errorData.error || errorData.details || errorMessage;
            } catch (e) {
              const text = await response.text();
              if (text) {
                errorMessage = text;
              }
            }
            throw new Error(errorMessage);
          }

          const payload = await response.json();
          const examples = Array.isArray(payload.examples) ? payload.examples : [];
          const newTestcases = examples.map((ex) => ({
            event_type: ex.event_type || ex.eventType || ex.event || null,
            text: ex.text || "",
            trigger: typeof ex.trigger === "boolean" ? ex.trigger : null,
            confidence: typeof ex.confidence === "number" ? ex.confidence : null,
            raw: ex,
            evaluation: null,
          }));

          currentTestcases = currentTestcases.concat(newTestcases);
          // Keep the previous selection or clear it? Clear feels safer after generation.
          selectedIds.clear();
          renderTestcases();
        } catch (error) {
          console.error("Error generating similar testcases:", error);
          alert(error.message || "Something went wrong while generating similar testcases.");
        } finally {
          generateMoreLikeButton.disabled = false;
          generateMoreLikeButton.textContent = "Generate more like these";
        }
      }

      generateMoreLikeButton.addEventListener("click", () => {
        handleGenerateMoreLike();
      });

      generateDatasetButton.addEventListener("click", () => {
        alert("Dataset generation workflow is not implemented yet. This button is a placeholder for now.");
      });

      // Initial empty state
      setPanelPlaceholder(resultPanel, "Generated testcases will appear here...");
    </script>
  </body>
</html>

