<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ModDash</title>
    <style>
      :root {
        color-scheme: light;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #f4f4f7;
        color: #222;
      }

      .page {
        min-height: 100vh;
        padding: 32px;
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      header h1 {
        margin: 0;
        font-size: 2.25rem;
        letter-spacing: 0.08em;
        font-weight: 600;
      }

      .layout {
        display: grid;
        grid-template-columns: 360px 1fr;
        gap: 24px;
        flex-grow: 1;
      }

      .card {
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 20px 45px rgba(15, 23, 42, 0.1);
        padding: 28px;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .field label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        font-size: 0.95rem;
      }

      .field textarea {
        width: 100%;
        min-height: 120px;
        border: 1px solid #d8dae5;
        border-radius: 16px;
        padding: 16px;
        font: inherit;
        resize: vertical;
        outline: none;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }

      .field textarea:focus {
        border-color: #6366f1;
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15);
      }

      .hint {
        font-size: 0.85rem;
        color: #6b7280;
        margin-top: 6px;
      }

      button {
        border: none;
        border-radius: 16px;
        padding: 14px 20px;
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }

      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 25px rgba(99, 102, 241, 0.25);
      }

      button:active {
        transform: translateY(0);
        box-shadow: none;
      }

      .results {
        display: grid;
        grid-template-rows: auto 1fr;
        gap: 16px;
      }

      .results-header {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 16px;
        font-weight: 600;
        font-size: 0.95rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #4b5563;
      }

      .results-panels {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 16px;
      }

      .panel {
        background: #fff;
        border-radius: 18px;
        box-shadow: inset 0 0 0 2px #e5e7eb;
        padding: 20px;
        min-height: 220px;
        font-size: 0.95rem;
        color: #4b5563;
      }

      .panel[data-placeholder]:empty::before {
        content: attr(data-placeholder);
        color: #9ca3af;
      }

      .dataset-table {
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 16px;
        border-radius: 12px;
        background: rgba(99, 102, 241, 0.05);
      }

      .dataset-table h3 {
        margin: 0;
        font-size: 1.05rem;
        color: #3730a3;
      }

      .dataset-table .columns {
        margin: 0;
        display: grid;
        gap: 4px;
      }

      .dataset-table .columns dt {
        font-weight: 600;
      }

      .dataset-table .columns dd {
        margin: 0 0 8px 0;
        color: #4b5563;
      }

      .sample-rows {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
      }

      .sample-rows th,
      .sample-rows td {
        border: 1px solid #e5e7eb;
        padding: 6px 8px;
        text-align: left;
      }

      .sample-rows th {
        background: #eef2ff;
      }

      .fallback-note {
        margin: 12px 0 0;
        padding: 12px;
        border-radius: 12px;
        background: rgba(217, 119, 6, 0.12);
        color: #b45309;
        font-weight: 600;
      }

      button:disabled {
        opacity: 0.7;
        cursor: progress;
      }

      @media (max-width: 960px) {
        .layout {
          grid-template-columns: 1fr;
        }

        .results-header {
          grid-template-columns: 1fr;
        }

        .results-panels {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <header>
        <h1>ModDash</h1>
      </header>
      <main class="layout">
        <section class="card" aria-labelledby="rule-builder">
          <div class="field">
            <label id="rule-builder" for="rule">Write a rule you want to test...</label>
            <textarea id="rule" name="rule" placeholder="e.g., Block messages containing more than 3 links"></textarea>
          </div>

          <div class="field">
            <label for="example">[Optional] Give an example case</label>
            <textarea
              id="example"
              name="example"
              placeholder="Paste a message or scenario to preview how the rule behaves"
            ></textarea>
            <p class="hint">Use this space to test the rule against a specific message.</p>
          </div>

          <button id="generate" type="button">Generate</button>
        </section>

        <section class="results">
          <div class="results-header">
            <span>Result</span>
            <span>Dataset</span>
          </div>
          <div class="results-panels">
            <div
              id="result-panel"
              class="panel"
              data-placeholder="Generated results will appear here..."
            ></div>
            <div
              id="dataset-panel"
              class="panel"
              data-placeholder="Generated datasets will appear here..."
            ></div>
          </div>
        </section>
      </main>
    </div>
    <script type="module">
      const ruleField = document.querySelector("#rule");
      const exampleField = document.querySelector("#example");
      const generateButton = document.querySelector("#generate");
      const resultPanel = document.querySelector("#result-panel");
      const datasetPanel = document.querySelector("#dataset-panel");

      const API_BASE = window.__MODDASH_API_BASE__ || "http://127.0.0.1:8000";

      function setPanelContent(panel, nodes) {
        panel.innerHTML = "";
        panel.removeAttribute("data-placeholder");
        if (!Array.isArray(nodes)) {
          nodes = [nodes];
        }
        nodes.forEach((node) => panel.append(node));
      }

      function setPanelPlaceholder(panel, text) {
        panel.textContent = "";
        if (text) {
          panel.dataset.placeholder = text;
        } else {
          delete panel.dataset.placeholder;
        }
      }

      function createParagraph(text) {
        const paragraph = document.createElement("p");
        paragraph.textContent = text;
        return paragraph;
      }

      function createPreformatted(text) {
        const pre = document.createElement("pre");
        pre.textContent = text;
        pre.style.whiteSpace = "pre-wrap";
        pre.style.wordBreak = "break-word";
        return pre;
      }

      function createTableElement(table) {
        const container = document.createElement("article");
        container.className = "dataset-table";

        const heading = document.createElement("h3");
        heading.textContent = table.name;
        container.append(heading);

        if (table.description) {
          container.append(createParagraph(table.description));
        }

        if (Array.isArray(table.columns) && table.columns.length) {
          const columnList = document.createElement("dl");
          columnList.className = "columns";

          table.columns.forEach((column) => {
            const title = document.createElement("dt");
            title.textContent = `${column.name} (${column.type})`;
            columnList.append(title);

            if (column.description) {
              const detail = document.createElement("dd");
              detail.textContent = column.description;
              columnList.append(detail);
            }
          });

          container.append(columnList);
        }

        if (Array.isArray(table.sampleRows) && table.sampleRows.length) {
          const tableElement = document.createElement("table");
          tableElement.className = "sample-rows";
          const headerRow = document.createElement("tr");

          const keys = Object.keys(table.sampleRows[0]);
          keys.forEach((key) => {
            const th = document.createElement("th");
            th.textContent = key;
            headerRow.append(th);
          });

          tableElement.append(headerRow);

          table.sampleRows.forEach((row) => {
            const tr = document.createElement("tr");
            keys.forEach((key) => {
              const td = document.createElement("td");
              td.textContent = row[key] ?? "";
              tr.append(td);
            });
            tableElement.append(tr);
          });

          container.append(tableElement);
        }

        return container;
      }

      async function handleGenerate() {
        const rule = ruleField.value.trim();
        const example = exampleField.value.trim();

        if (!rule) {
          alert("Please enter a rule before generating a dataset.");
          return;
        }

        generateButton.disabled = true;
        generateButton.textContent = "Generating...";

        setPanelPlaceholder(resultPanel, "Working on it...");
        setPanelPlaceholder(datasetPanel, "Working on it...");

        try {
          const response = await fetch(`${API_BASE}/generate`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ rule, example: example || null }),
          });

          if (!response.ok) {
            const message = await response.text();
            throw new Error(message || `Request failed with status ${response.status}`);
          }

          const payload = await response.json();

          const summaryNodes = [];
          if (payload.notes) {
            summaryNodes.push(createParagraph(payload.notes));
          }

          if (payload.prompt) {
            const promptLabel = document.createElement("h3");
            promptLabel.textContent = "Prompt sent to GPT";
            summaryNodes.push(promptLabel, createPreformatted(payload.prompt));
          }

          if (payload.usedFallback) {
            const warning = document.createElement("p");
            warning.className = "fallback-note";
            warning.textContent = "Fallback dataset used (no live GPT response).";
            summaryNodes.push(warning);
          }

          setPanelContent(resultPanel, summaryNodes);

          if (Array.isArray(payload.tables) && payload.tables.length) {
            const tableNodes = payload.tables.map(createTableElement);
            setPanelContent(datasetPanel, tableNodes);
          } else {
            setPanelPlaceholder(datasetPanel, "No dataset information was returned.");
          }
        } catch (error) {
          console.error(error);
          setPanelContent(resultPanel, createParagraph("Something went wrong while generating the dataset."));
          setPanelPlaceholder(datasetPanel, "Unable to generate dataset.");
        } finally {
          generateButton.disabled = false;
          generateButton.textContent = "Generate";
        }
      }

      generateButton.addEventListener("click", () => {
        handleGenerate();
      });

      [ruleField, exampleField].forEach((field) => {
        field.addEventListener("keydown", (event) => {
          if (event.key === "Enter" && (event.metaKey || event.ctrlKey)) {
            event.preventDefault();
            handleGenerate();
          }
        });
      });
    </script>
  </body>
</html>

